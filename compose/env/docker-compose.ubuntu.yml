version: '3.8'

# Ubuntu/Linux-specific overrides for production deployment
services:
  traefik:
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${HOMELAB_DATA_ROOT}/traefik:/data
      - ${HOMELAB_DATA_ROOT}/config/traefik:/etc/traefik/dynamic:ro
    # Enable host networking for better performance if needed
    # network_mode: host
    extra_hosts:
      - "host.docker.internal:host-gateway"

  portainer:
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${HOMELAB_DATA_ROOT}/portainer:/data

  prometheus:
    volumes:
      - ${HOMELAB_DATA_ROOT}/config/monitoring/prometheus:/etc/prometheus:ro
      - ${HOMELAB_DATA_ROOT}/prometheus:/prometheus
    user: "65534:65534"  # nobody user for security

  grafana:
    volumes:
      - ${HOMELAB_DATA_ROOT}/grafana:/var/lib/grafana
      - ${HOMELAB_DATA_ROOT}/config/monitoring/grafana:/etc/grafana/provisioning:ro
    user: "472:472"  # grafana user

  watchtower:
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    # Run with higher privileges on Linux for system updates
    privileged: false
    security_opt:
      - no-new-privileges:true

  nextcloud-db:
    volumes:
      - ${HOMELAB_DATA_ROOT}/nextcloud-db:/var/lib/mysql
    user: "999:999"  # mysql user

  nextcloud:
    volumes:
      - ${HOMELAB_DATA_ROOT}/nextcloud:/var/www/html
      - ${HOMELAB_DATA_ROOT}/config/nextcloud:/var/www/html/config:ro
    user: "33:33"  # www-data user
