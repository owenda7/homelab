version: '3.8'

networks:
  homelab:
    name: ${HOMELAB_NETWORK:-homelab}
    driver: bridge
    ipam:
      config:
        - subnet: ${DOCKER_SUBNET:-172.20.0.0/16}

volumes:
  traefik-data:
  portainer-data:
  nextcloud-data:
  nextcloud-db-data:
  pihole-data:
  pihole-dnsmasq:

services:
  # Reverse Proxy & SSL Termination
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: unless-stopped
    command:
      - --api.dashboard=${TRAEFIK_API_DASHBOARD:-true}
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=${HOMELAB_NETWORK:-homelab}
      - --providers.docker.endpoint=unix:///var/run/docker.sock
      - --providers.docker.watch=true
      - --providers.file.directory=/etc/traefik/dynamic
      - --providers.file.watch=true
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}
      - --certificatesresolvers.letsencrypt.acme.storage=/data/acme.json
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
      - --log.level=${TRAEFIK_LOG_LEVEL:-INFO}
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-data:/data
      - ./config/traefik:/etc/traefik/dynamic:ro
    networks:
      - homelab
    labels:
      - traefik.enable=true
      - traefik.http.routers.traefik.rule=Host(`traefik.${HOMELAB_DOMAIN}`)
      - traefik.http.routers.traefik.service=api@internal
      - traefik.http.routers.traefik.entrypoints=web
    environment:
      - TZ=${TZ:-UTC}

  # Container Management
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer-data:/data
    networks:
      - homelab
    labels:
      - traefik.enable=true
      - traefik.http.routers.portainer.rule=Host(`portainer.${HOMELAB_DOMAIN}`)
      - traefik.http.routers.portainer.entrypoints=web
      - traefik.http.services.portainer.loadbalancer.server.port=9000
    environment:
      - TZ=${TZ:-UTC}


  # Container Updates
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - TZ=${TZ:-UTC}
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_SCHEDULE=0 0 4 * * *  # 4 AM daily
    networks:
      - homelab

  # Nextcloud Database
  nextcloud-db:
    image: mariadb:10.11
    container_name: nextcloud-db
    restart: unless-stopped
    command: --transaction-isolation=READ-COMMITTED --log-bin=binlog --binlog-format=ROW
    volumes:
      - nextcloud-db-data:/var/lib/mysql
    environment:
      - TZ=${TZ:-UTC}
      - MYSQL_ROOT_PASSWORD=${NEXTCLOUD_DB_ROOT_PASSWORD:-changeme}
      - MYSQL_PASSWORD=${NEXTCLOUD_DB_PASSWORD:-changeme}
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
    networks:
      - homelab

  # Nextcloud - File Storage & Collaboration
  nextcloud:
    image: nextcloud:28-apache
    container_name: nextcloud
    restart: unless-stopped
    depends_on:
      - nextcloud-db
    volumes:
      - nextcloud-data:/var/www/html
    environment:
      - TZ=${TZ:-UTC}
      - MYSQL_HOST=nextcloud-db
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=${NEXTCLOUD_DB_PASSWORD:-changeme}
      - NEXTCLOUD_ADMIN_USER=${NEXTCLOUD_ADMIN_USER:-admin}
      - NEXTCLOUD_ADMIN_PASSWORD=${NEXTCLOUD_ADMIN_PASSWORD:-changeme}
      - NEXTCLOUD_TRUSTED_DOMAINS=localhost nextcloud.${HOMELAB_DOMAIN} ${HOMELAB_DOMAIN}
      - OVERWRITEPROTOCOL=http
      - OVERWRITEHOST=localhost:8000
    networks:
      - homelab
    labels:
      - traefik.enable=true
      - traefik.http.routers.nextcloud.rule=Host(`nextcloud.${HOMELAB_DOMAIN}`)
      - traefik.http.routers.nextcloud.entrypoints=web
      - traefik.http.services.nextcloud.loadbalancer.server.port=80
      - traefik.http.routers.nextcloud.middlewares=nextcloud-headers
      - traefik.http.middlewares.nextcloud-headers.headers.customRequestHeaders.X-Forwarded-Proto=https
      - traefik.http.middlewares.nextcloud-headers.headers.customRequestHeaders.X-Forwarded-Host=nextcloud.${HOMELAB_DOMAIN}

  # Pi-hole - DNS & Ad Blocking
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    restart: unless-stopped
    hostname: pihole
    volumes:
      - pihole-data:/etc/pihole
      - pihole-dnsmasq:/etc/dnsmasq.d
    environment:
      - TZ=${TZ:-UTC}
      - WEBPASSWORD=${PIHOLE_PASSWORD:-admin}
      - PIHOLE_DNS_1=${PIHOLE_DNS_1:-8.8.8.8}
      - PIHOLE_DNS_2=${PIHOLE_DNS_2:-8.8.4.4}
      - DNSMASQ_LISTENING=all
      - VIRTUAL_HOST=pihole.${HOMELAB_DOMAIN}
      - FTLCONF_LOCAL_IPV4=${PIHOLE_LOCAL_IP:-172.20.0.100}
    networks:
      homelab:
        ipv4_address: ${PIHOLE_LOCAL_IP:-172.20.0.100}
    labels:
      - traefik.enable=true
      - traefik.http.routers.pihole.rule=Host(`pihole.${HOMELAB_DOMAIN}`)
      - traefik.http.routers.pihole.entrypoints=web
      - traefik.http.services.pihole.loadbalancer.server.port=80
      - traefik.http.routers.pihole.middlewares=pihole-admin
      - traefik.http.middlewares.pihole-admin.addprefix.prefix=/admin
